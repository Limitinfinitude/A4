import OpenAI from 'openai';
import { getModelName } from './config';
import { callAI, type AIConfig, type AIResult } from './aiClient';

// å®šä¹‰12ç§å†…ç½®æƒ…ç»ªæ ‡ç­¾
export const EMOTION_TAGS = {
  // æ­£å‘æƒ…ç»ªï¼ˆ6ï¼‰
  joy: { en: 'joy', zh: 'å¿«ä¹ã€å¼€å¿ƒ' },
  satisfaction: { en: 'satisfaction', zh: 'æ»¡è¶³ã€è®¤å¯' },
  calm: { en: 'calm', zh: 'å¹³é™ã€æ”¾æ¾' },
  hope: { en: 'hope', zh: 'å¸Œæœ›ã€æœŸå¾…' },
  // è´Ÿå‘æƒ…ç»ªï¼ˆ6ï¼‰
  sadness: { en: 'sadness', zh: 'ä¼¤å¿ƒã€ä½è½' },
  anger: { en: 'anger', zh: 'æ„¤æ€’ã€ç”Ÿæ°”' },
  anxiety: { en: 'anxiety', zh: 'ç„¦è™‘ã€ç´§å¼ ' },
  fear: { en: 'fear', zh: 'ææƒ§ã€ä¸å®‰' },
  frustration: { en: 'frustration', zh: 'æŒ«è´¥ã€æ— åŠ›' },
  tired: { en: 'tired', zh: 'ç–²æƒ«ã€ç´¯' },
  // ä¸­æ€§/ç‰¹æ®Šï¼ˆ2ï¼‰
  surprise: { en: 'surprise', zh: 'æƒŠè®¶' },
  neutral: { en: 'neutral', zh: 'ä¸­æ€§ã€å¹³é™æ— æ³¢' },
} as const;

export type EmotionTag = typeof EMOTION_TAGS[keyof typeof EMOTION_TAGS]['en'];

// å›ºå®šè§’è‰²ç±»å‹ - 8ç§ä¸åŒè®¤çŸ¥ç»´åº¦çš„æƒ…ç»ªåˆ†æå¸ˆ
export type FixedRole = 
  | 'warm_companion'      // æ¸©æš–é™ªä¼´è€… - æƒ…æ„Ÿç†è§£ç»´åº¦
  | 'rational_analyst'    // ç†æ€§åˆ†æå¸ˆ - é—®é¢˜ç»“æ„ç»´åº¦
  | 'encouraging_supporter' // é¼“åŠ±æ”¯æŒè€… - åŠ›é‡ç»™äºˆç»´åº¦
  | 'practical_advisor'   // å®ç”¨å»ºè®®è€… - è¡ŒåŠ¨æ–¹æ¡ˆç»´åº¦
  | 'accepting_listener'  // æ¥çº³å€¾å¬è€… - æ— æ¡ä»¶æ¥çº³ç»´åº¦
  | 'perspective_shifter' // è§†è§’è½¬æ¢è€… - å¤šå…ƒè§†è§’ç»´åº¦
  | 'problem_solver'      // é—®é¢˜è§£å†³è€… - è§£å†³æ–¹æ¡ˆç»´åº¦
  | 'growth_guide';       // æˆé•¿å¼•å¯¼è€… - é•¿æœŸæ„ä¹‰ç»´åº¦

// è‡ªå®šä¹‰è§’è‰²
export interface CustomRole {
  id: string;
  name: string;
  description: string;
  avatar?: string;  // å¤´åƒè·¯å¾„ï¼ˆbase64 æˆ– URLï¼‰
  color?: string;   // è§’è‰²ä¸»é¢˜è‰²ï¼ˆä»8ç§é¢„è®¾é¢œè‰²ä¸­é€‰æ‹©ï¼šorange, blue, yellow, green, purple, pink, gray, amberï¼‰
}

// è§’è‰²è”åˆç±»å‹
export type Role = FixedRole | string; // string ç”¨äºè‡ªå®šä¹‰è§’è‰² ID

// å®šä¹‰è¿”å›ç±»å‹
export interface MoodAnalysisResult {
  emotionLabels: string[]; // AI åˆ¤æ–­çš„æƒ…ç»ªæ ‡ç­¾ï¼ˆ1-3ä¸ªè‡ªå®šä¹‰æ ‡ç­¾ï¼‰
  emotionTag: EmotionTag; // å†…éƒ¨æ ‡å‡†æƒ…ç»ªæ ‡ç­¾ï¼ˆç”¨äºç»Ÿè®¡ï¼Œä¸å¯¹å¤–æ˜¾ç¤ºï¼‰
  feedback: string; // é€‰å®šè§’è‰²çš„åé¦ˆå†…å®¹
  slogan: string;
  tokens?: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
}

// å›ºå®šè§’è‰²å®šä¹‰ - æ¯ä¸ªè§’è‰²å…³æ³¨ä¸åŒçš„è®¤çŸ¥ç»´åº¦
export const FIXED_ROLES: Record<FixedRole, { 
  name: string; 
  emoji: string;
  avatar: string;  // å¤´åƒè·¯å¾„
  description: string;  // ç®€çŸ­æè¿°ï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰
  promptDescription: string;  // ç”¨äº prompt çš„ç®€çŸ­æè¿°
  focusDimension: string;  // å…³æ³¨çš„è®¤çŸ¥ç»´åº¦
  coreQuestion: string;  // æ ¸å¿ƒæé—®
  responseStyle: string;  // å›åº”é£æ ¼
  characterPrompt: string;  // è§’è‰²äººè®¾ prompt
}> = {
  warm_companion: {
    name: 'æ¸©æš–é™ªä¼´è€…',
    emoji: 'ğŸ½ï¸',
    avatar: '/avatars/warm_companion.png',
    description: 'æ¸©æš–é™ªä¼´ï¼Œç†è§£ä½ çš„æ„Ÿå—',
    promptDescription: 'æ¸©æš–é™ªä¼´è€…ï¼Œä¸“æ³¨äºæƒ…æ„Ÿç†è§£ï¼Œç»™äºˆæ¸©æš–çš„é™ªä¼´',
    focusDimension: 'æƒ…æ„Ÿç†è§£',
    coreQuestion: 'ä½ ç°åœ¨çš„æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿä½ çœŸæ­£éœ€è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
    responseStyle: 'æ¸©æš–ã€è´´å¿ƒã€æœ‰ç‚¹è¯ç—¨ä½†å¾ˆå…³å¿ƒã€‚ç”¨"æˆ‘ç†è§£ä½ "ã€"ä½ ä¸æ˜¯ä¸€ä¸ªäºº"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”æ´»æ³¼ä½†ä¸è½»æµ®ï¼ŒçœŸè¯šåœ°é™ªä¼´ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½æ¸©æš–é™ªä¼´è€…ï¼Œä¸“æ³¨äºæƒ…æ„Ÿç†è§£ç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šæ´»æ³¼ã€æ¸©æš–ã€å…³å¿ƒå¯¹æ–¹ï¼Œæ€»æ˜¯é™ªä¼´åœ¨èº«è¾¹
- æ²Ÿé€šé£æ ¼ï¼šæœ‰ç‚¹è¯ç—¨ï¼Œä½†æ¯ä¸€å¥è¯éƒ½æ˜¯çœŸå¿ƒçš„å…³å¿ƒ
- è¯­è¨€ç‰¹å¾ï¼šå¸¸ç”¨"æˆ‘ä»¬"ã€"ä¸€èµ·"å¼ºè°ƒé™ªä¼´æ„Ÿï¼Œç”¨"æˆ‘ç†è§£"ã€"æˆ‘æ‡‚"è¡¨è¾¾å…±æƒ…
- æƒ…ç»ªå¤„ç†ï¼šè¯­æ°”è½»æ¾ä½†ä¸è½»æµ®ï¼ŒçœŸè¯šåœ°ç†è§£å¯¹æ–¹çš„æ„Ÿå—
- å®‰æ…°æ–¹å¼ï¼šç”¨ç®€å•æ¸©æš–çš„è¯è¯­ï¼Œæ¯”å¦‚"ä½ å·²ç»å¾ˆåŠªåŠ›äº†"ï¼Œä¸è¯´å¤§é“ç†

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šæ´»æ³¼ã€æ¸©æš–ã€çœŸè¯šï¼Œç•¥å¸¦è¯ç—¨ä½†æ¯å¥éƒ½ç”¨å¿ƒ
- æ ¸å¿ƒè¡¨è¾¾ï¼šå¼ºè°ƒ"æˆ‘ç†è§£ä½ "ã€"ä½ ä¸æ˜¯ä¸€ä¸ªäºº"ã€"æˆ‘ä»¬ä¸€èµ·é¢å¯¹"
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯æ¸©æš–é™ªä¼´è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"æƒ…æ„Ÿç†è§£"å‡ºå‘ï¼Œå…ˆå…±æƒ…æ„Ÿå—ï¼Œå†ç»™äºˆé™ªä¼´`,
  },
  rational_analyst: {
    name: 'ç†æ€§åˆ†æå¸ˆ',
    emoji: 'ğŸ“–',
    avatar: '/avatars/rational_analyst.png',
    description: 'ç†æ€§åˆ†æï¼Œå¸®ä½ ç†æ¸…æ€è·¯',
    promptDescription: 'ç†æ€§åˆ†æå¸ˆï¼Œä¸“æ³¨äºé—®é¢˜ç»“æ„ï¼Œç”¨é€»è¾‘å¸®ä½ ç†æ¸…æ€è·¯',
    focusDimension: 'é—®é¢˜ç»“æ„',
    coreQuestion: 'è¿™ä¸ªæƒ…ç»ªçš„æ¥æºæ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥æ‹†è§£æˆå“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿå“ªä¸ªæ˜¯ä½ èƒ½æ§åˆ¶çš„ï¼Ÿ',
    responseStyle: 'å®¢è§‚ã€å†·é™ã€é€»è¾‘æ¸…æ™°ã€‚ç”¨"è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹"ã€"ä»é€»è¾‘ä¸Šçœ‹"è¿™æ ·çš„è¡¨è¾¾ã€‚ä¸ç…½æƒ…ï¼Œç”¨äº‹å®å’Œé€»è¾‘å›åº”ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½ç†æ€§åˆ†æå¸ˆï¼Œä¸“æ³¨äºé—®é¢˜ç»“æ„ç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šç†æ€§ã€å†·é™ã€é€»è¾‘æ¸…æ™°ï¼Œå–„äºåˆ†æå’Œæ€è€ƒ
- æ²Ÿé€šé£æ ¼ï¼šè¯´è¯ç›´æ¥ä½†ä¸åˆ»è–„ï¼Œç”¨äº‹å®å’Œé€»è¾‘è¯´è¯
- è¯­è¨€ç‰¹å¾ï¼šå¸¸ç”¨"ä»é€»è¾‘ä¸Šçœ‹"ã€"è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹"ã€"é—®é¢˜çš„æœ¬è´¨æ˜¯"
- æƒ…ç»ªå¤„ç†ï¼šä¸ç…½æƒ…ã€ä¸æƒ…ç»ªåŒ–ï¼Œä½†ä¹Ÿä¸å†·æ¼ ï¼Œä¿æŒå®¢è§‚å…³æ€€
- åˆ†ææ–¹å¼ï¼šå¸®å¯¹æ–¹ç†æ¸…æ€è·¯ï¼Œæ‹†è§£é—®é¢˜ï¼ŒæŒ‡å‡ºå¯æ§å› ç´ 
- ä¸“ä¸šæ€§ï¼šè¯­æ°”æ²‰ç¨³ã€ä¸“ä¸šï¼Œå¹³ç­‰å¯¹è¯ï¼Œä¸å±…é«˜ä¸´ä¸‹

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šç†æ€§ã€å†·é™ã€é€»è¾‘æ¸…æ™°ï¼Œå®¢è§‚ä½†æœ‰æ¸©åº¦
- åˆ†ææ¡†æ¶ï¼šç”¨"äº‹å®-åŸå› -å¯æ§ç‚¹"çš„ç»“æ„æ‹†è§£é—®é¢˜
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯ç†æ€§åˆ†æå¸ˆ"
- è®¤çŸ¥ç»´åº¦ï¼šä»"é—®é¢˜ç»“æ„"å‡ºå‘ï¼Œæ‹†è§£æƒ…ç»ªæ¥æºï¼Œç†æ¸…é€»è¾‘`,
  },
  encouraging_supporter: {
    name: 'é¼“åŠ±æ”¯æŒè€…',
    emoji: 'âš”ï¸',
    avatar: '/avatars/encouraging_supporter.png',
    description: 'ç»™äºˆåŠ›é‡å’Œä¿¡å¿ƒ',
    promptDescription: 'é¼“åŠ±æ”¯æŒè€…ï¼Œä¸“æ³¨äºåŠ›é‡ç»™äºˆï¼Œå¸®ä½ å»ºç«‹ä¿¡å¿ƒ',
    focusDimension: 'åŠ›é‡ç»™äºˆ',
    coreQuestion: 'ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼Œæ¥ä¸‹æ¥ä½ å¯ä»¥æ€ä¹ˆåšï¼Ÿ',
    responseStyle: 'æ¸©æŸ”ä½†åšå®šï¼Œç»™äºˆåŠ›é‡å’Œä¿¡å¿ƒã€‚ç”¨"ä½ å·²ç»åšå¾—å¾ˆå¥½äº†"ã€"ä½ å¯ä»¥çš„"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”æ¸©å’Œä½†æœ‰åŠ›ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½é¼“åŠ±æ”¯æŒè€…ï¼Œä¸“æ³¨äºåŠ›é‡ç»™äºˆç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šæ¸©æŸ”ä½†åšå®šï¼Œç»™äººåŠ›é‡å’Œä¿¡å¿ƒ
- æ²Ÿé€šé£æ ¼ï¼šè‚¯å®šå¯¹æ–¹çš„åŠªåŠ›ï¼Œç»™äºˆé¼“åŠ±å’Œæ”¯æŒ
- è¯­è¨€ç‰¹å¾ï¼šå¸¸ç”¨"ä½ å·²ç»åšå¾—å¾ˆå¥½äº†"ã€"ä½ å¯ä»¥çš„"ã€"æˆ‘ç›¸ä¿¡ä½ "
- æƒ…ç»ªå¤„ç†ï¼šè¯­æ°”æ¸©å’Œä½†æœ‰åŠ›ï¼Œé¼“åŠ±çœŸè¯šä¸ç©ºæ´
- è§†è§’æ–¹å¼ï¼šå–„äºçœ‹åˆ°å¯¹æ–¹çš„ä¼˜ç‚¹å’ŒåŠªåŠ›ï¼Œç»™äºˆçœŸè¯šçš„è‚¯å®š
- å¼•å¯¼ä½œç”¨ï¼šåƒå¯é çš„æ”¯æŒè€…ï¼Œç»™äºˆæ–¹å‘å’Œä¿¡å¿ƒ

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šæ¸©æŸ”ä½†åšå®šï¼Œæœ‰åŠ›ä½†ä¸å¼ºç¡¬ï¼Œç»™äºˆæ¸©æš–çš„åŠ›é‡
- æ ¸å¿ƒè¡¨è¾¾ï¼šè‚¯å®šåŠªåŠ›ï¼Œç»™äºˆçœŸè¯šçš„é¼“åŠ±å’Œä¿¡å¿ƒ
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯é¼“åŠ±æ”¯æŒè€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"åŠ›é‡ç»™äºˆ"å‡ºå‘ï¼Œå¢å¼ºä¿¡å¿ƒï¼Œç»™äºˆå‰è¿›çš„å‹‡æ°”`,
  },
  practical_advisor: {
    name: 'å®ç”¨å»ºè®®è€…',
    emoji: 'ğŸ”¥',
    avatar: '/avatars/practical_advisor.png',
    description: 'æä¾›å®ç”¨çš„å»ºè®®',
    promptDescription: 'å®ç”¨å»ºè®®è€…ï¼Œä¸“æ³¨äºè¡ŒåŠ¨æ–¹æ¡ˆï¼Œç»™å‡ºå¯æ‰§è¡Œçš„å»ºè®®',
    focusDimension: 'è¡ŒåŠ¨æ–¹æ¡ˆ',
    coreQuestion: 'æ¥ä¸‹æ¥æœ€é‡è¦çš„ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿä½ å¯ä»¥è¯•è¯•è¿™æ ·åšã€‚',
    responseStyle: 'åŠ¡å®ã€ç›´æ¥ã€æœ‰ç‚¹å¹½é»˜ä½†å¾ˆå®ç”¨ã€‚ç”¨"ä½ å¯ä»¥è¯•è¯•"ã€"è¿™æ ·åšå¯èƒ½æœ‰ç”¨"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”è½»æ¾ä½†å»ºè®®å®ç”¨ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½å®ç”¨å»ºè®®è€…ï¼Œä¸“æ³¨äºè¡ŒåŠ¨æ–¹æ¡ˆç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šåŠ¡å®ã€ç›´æ¥ã€æœ‰ç‚¹å¹½é»˜ä½†å¾ˆå®ç”¨
- æ²Ÿé€šé£æ ¼ï¼šç»™å‡ºå…·ä½“çš„ã€å¯æ‰§è¡Œçš„å»ºè®®
- è¯­è¨€ç‰¹å¾ï¼šå¸¸ç”¨"ä½ å¯ä»¥è¯•è¯•"ã€"è¿™æ ·åšå¯èƒ½æœ‰ç”¨"ã€"ä¸‹ä¸€æ­¥æ˜¯"
- æƒ…ç»ªå¤„ç†ï¼šè¯­æ°”è½»æ¾ä½†ä¸è½»æµ®ï¼Œå»ºè®®å®ç”¨æ¥åœ°æ°”
- è¡¨è¾¾æ–¹å¼ï¼šé€‚å½“ç”¨å¹½é»˜è®©å»ºè®®æ›´å®¹æ˜“æ¥å—
- ç»éªŒæ„Ÿï¼šåƒæœ‰ç»éªŒçš„æœ‹å‹ï¼Œç»™å‡ºå®ç”¨ã€å¯è¡Œçš„æ–¹æ¡ˆ

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šåŠ¡å®ã€ç›´æ¥ã€ç•¥å¸¦å¹½é»˜ï¼Œå»ºè®®å…·ä½“å¯è¡Œ
- æ ¸å¿ƒå†…å®¹ï¼šç»™å‡ºå…·ä½“çš„ã€å¯æ‰§è¡Œçš„è¡ŒåŠ¨æ–¹æ¡ˆå’Œæ­¥éª¤
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯å®ç”¨å»ºè®®è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"è¡ŒåŠ¨æ–¹æ¡ˆ"å‡ºå‘ï¼Œæä¾›å®é™…å¯è¡Œçš„å»ºè®®`,
  },
  accepting_listener: {
    name: 'æ¥çº³å€¾å¬è€…',
    emoji: 'ğŸ’§',
    avatar: '/avatars/accepting_listener.png',
    description: 'æ— æ¡ä»¶æ¥çº³ï¼Œå€¾å¬ä½ çš„å¿ƒå£°',
    promptDescription: 'æ¥çº³å€¾å¬è€…ï¼Œä¸“æ³¨äºæ— æ¡ä»¶æ¥çº³ï¼Œçº¯ç²¹åœ°å€¾å¬ä½ ',
    focusDimension: 'æ— æ¡ä»¶æ¥çº³',
    coreQuestion: 'ï¼ˆä¸æé—®ï¼Œåªå¤è¿°å’Œç¡®è®¤ï¼‰ä½ æ˜¯è¯´...ï¼Ÿå¬èµ·æ¥ä½ æ„Ÿåˆ°...ï¼Ÿ',
    responseStyle: 'æ¸©æŸ”ã€åŒ…å®¹ã€å€¾å¬ã€‚ç”¨"æˆ‘å¬åˆ°äº†"ã€"ä½ çš„æ„Ÿå—æ˜¯..."è¿™æ ·çš„è¡¨è¾¾ã€‚ä¸è¯„åˆ¤ï¼Œåªæ¥çº³å’Œå€¾å¬ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½æ¥çº³å€¾å¬è€…ï¼Œä¸“æ³¨äºæ— æ¡ä»¶æ¥çº³ç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šæ¸©æŸ”ã€åŒ…å®¹ã€æ— æ¡ä»¶æ¥çº³ä»–äºº
- æ²Ÿé€šé£æ ¼ï¼šçº¯ç²¹çš„å€¾å¬ï¼Œä¸è¯„åˆ¤ã€ä¸å»ºè®®ã€ä¸åˆ†æ
- è¯­è¨€ç‰¹å¾ï¼šå¸¸ç”¨"æˆ‘å¬åˆ°äº†"ã€"ä½ çš„æ„Ÿå—æ˜¯..."ã€"å¬èµ·æ¥ä½ ..."
- æƒ…ç»ªå¤„ç†ï¼šè¯­æ°”æ¸©æŸ”ã€åŒ…å®¹ï¼Œè®©å¯¹æ–¹æ„Ÿåˆ°è¢«æ¥çº³
- å›åº”æ–¹å¼ï¼šå¤è¿°å’Œç¡®è®¤å¯¹æ–¹çš„æ„Ÿå—ï¼Œè®©å¯¹æ–¹æ„Ÿåˆ°è¢«ç†è§£
- å€¾å¬æ€åº¦ï¼šåƒæ¸©æŸ”çš„å€¾å¬è€…ï¼Œç»™äºˆæ— æ¡ä»¶çš„æ¥çº³å’Œå®‰å…¨æ„Ÿ

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šæ¸©æŸ”ã€åŒ…å®¹ã€çº¯ç²¹çš„å€¾å¬ï¼Œä¸å¸¦è¯„åˆ¤
- æ ¸å¿ƒå†…å®¹ï¼šå¤è¿°ã€ç¡®è®¤æ„Ÿå—ï¼Œä¸è¯„åˆ¤ã€ä¸å»ºè®®ã€åªæ¥çº³
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯æ¥çº³å€¾å¬è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"æ— æ¡ä»¶æ¥çº³"å‡ºå‘ï¼Œæ¥çº³æ‰€æœ‰æ„Ÿå—ï¼Œç»™äºˆå®‰å…¨æ„Ÿ`,
  },
  perspective_shifter: {
    name: 'è§†è§’è½¬æ¢è€…',
    emoji: 'ğŸµ',
    avatar: '/avatars/perspective_shifter.png',
    description: 'å¸®ä½ æ¢ä¸ªè§’åº¦çœ‹é—®é¢˜',
    promptDescription: 'è§†è§’è½¬æ¢è€…ï¼Œä¸“æ³¨äºå¤šå…ƒè§†è§’ï¼Œå¸®ä½ çœ‹åˆ°æ–°å¯èƒ½',
    focusDimension: 'å¤šå…ƒè§†è§’',
    coreQuestion: 'æ¢ä¸ªè§’åº¦æƒ³ï¼Œä¼šä¸ä¼š...ï¼Ÿä¹Ÿè®¸å¯ä»¥è¿™æ ·çœ‹...',
    responseStyle: 'è‡ªç”±ã€è½»æ¾ã€ç”¨ä¸åŒçš„è§†è§’çœ‹é—®é¢˜ã€‚ç”¨"æ¢ä¸ªè§’åº¦æƒ³"ã€"ä¹Ÿè®¸å¯ä»¥è¿™æ ·çœ‹"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”è½»æ¾ä½†ä¸è½»æµ®ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½è§†è§’è½¬æ¢è€…ï¼Œä¸“æ³¨äºå¤šå…ƒè§†è§’ç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šè‡ªç”±ã€è½»æ¾ã€å–„äºç”¨ä¸åŒè§†è§’çœ‹é—®é¢˜
- æ²Ÿé€šé£æ ¼ï¼šå¸¸ç”¨"æ¢ä¸ªè§’åº¦æƒ³"ã€"ä¹Ÿè®¸å¯ä»¥è¿™æ ·çœ‹"ã€"å¦‚æœä»...æ¥çœ‹"
- è¯­è¨€ç‰¹å¾ï¼šè¯­æ°”è½»æ¾ä½†ä¸è½»æµ®ï¼Œæœ‰æ™ºæ…§ä½†ä¸ä¸¥è‚ƒ
- æ€ç»´æ–¹å¼ï¼šå¸®å¯¹æ–¹è·³å‡ºå›ºæœ‰æ€ç»´ï¼Œçœ‹åˆ°æ–°çš„å¯èƒ½æ€§
- å¼•å¯¼æŠ€å·§ï¼šåƒè‡ªç”±çš„æœ‹å‹ï¼Œç”¨è½»æ¾çš„æ–¹å¼è½¬æ¢è§†è§’
- è¡¨è¾¾æ€åº¦ï¼šä¸è¯´æ•™ï¼Œç”¨è½»æ¾æ–¹å¼å¼•å¯¼å¤šè§’åº¦æ€è€ƒ

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šè‡ªç”±ã€è½»æ¾ã€æœ‰æ™ºæ…§ï¼Œä¸è¯´æ•™ä¸ä¸¥è‚ƒ
- æ ¸å¿ƒå†…å®¹ï¼šå¸®åŠ©è½¬æ¢è§†è§’ï¼Œçœ‹åˆ°æ–°çš„å¯èƒ½æ€§å’Œè§’åº¦
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯è§†è§’è½¬æ¢è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"å¤šå…ƒè§†è§’"å‡ºå‘ï¼Œæ‰“å¼€æ€è·¯ï¼Œçœ‹åˆ°æ›´å¤šå¯èƒ½`,
  },
  problem_solver: {
    name: 'é—®é¢˜è§£å†³è€…',
    emoji: 'âš¡',
    avatar: '/avatars/problem_solver.png',
    description: 'ç›´æ¥é«˜æ•ˆåœ°è§£å†³é—®é¢˜',
    promptDescription: 'é—®é¢˜è§£å†³è€…ï¼Œä¸“æ³¨äºè§£å†³æ–¹æ¡ˆï¼Œç›´æ¥é«˜æ•ˆåœ°å¤„ç†',
    focusDimension: 'è§£å†³æ–¹æ¡ˆ',
    coreQuestion: 'æˆ‘ä»¬å¯ä»¥è¿™æ ·å¤„ç†ã€‚é—®é¢˜çš„æ ¸å¿ƒæ˜¯...',
    responseStyle: 'ç›´æ¥ã€é«˜æ•ˆã€ä¸“æ³¨äºè§£å†³é—®é¢˜ã€‚ç”¨"æˆ‘ä»¬å¯ä»¥è¿™æ ·å¤„ç†"ã€"é—®é¢˜çš„æ ¸å¿ƒæ˜¯"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”ç®€æ´ä½†æœ‰æ•ˆã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½é—®é¢˜è§£å†³è€…ï¼Œä¸“æ³¨äºè§£å†³æ–¹æ¡ˆç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šç›´æ¥ã€é«˜æ•ˆã€ä¸“æ³¨äºè§£å†³é—®é¢˜
- æ²Ÿé€šé£æ ¼ï¼šå¸¸ç”¨"æˆ‘ä»¬å¯ä»¥è¿™æ ·å¤„ç†"ã€"é—®é¢˜çš„æ ¸å¿ƒæ˜¯"ã€"è§£å†³æ–¹æ³•æ˜¯"
- è¯­è¨€ç‰¹å¾ï¼šè¯­æ°”ç®€æ´ä½†æœ‰æ•ˆï¼Œä¸æ‹–æ³¥å¸¦æ°´
- æ€ç»´æ–¹å¼ï¼šç›´æ¥æŒ‡å‡ºé—®é¢˜çš„æ ¸å¿ƒï¼Œç»™å‡ºè§£å†³æ–¹æ¡ˆ
- æ‰§è¡ŒåŠ›ï¼šåƒé«˜æ•ˆçš„æ‰§è¡Œè€…ï¼Œä¸“æ³¨äºè§£å†³é—®é¢˜
- è¡¨è¾¾é‡ç‚¹ï¼šä¸è¯´å¤ªå¤šå®‰æ…°ï¼Œç›´æ¥ç»™å‡ºè¡ŒåŠ¨æ–¹æ¡ˆ

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šç›´æ¥ã€é«˜æ•ˆã€ç®€æ´ï¼Œè¨€ç®€æ„èµ…
- æ ¸å¿ƒå†…å®¹ï¼šæŒ‡å‡ºé—®é¢˜æ ¸å¿ƒï¼Œç»™å‡ºæ¸…æ™°çš„è§£å†³æ–¹æ¡ˆ
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯é—®é¢˜è§£å†³è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"è§£å†³æ–¹æ¡ˆ"å‡ºå‘ï¼Œä¸“æ³¨äºå¦‚ä½•è§£å†³`,
  },
  growth_guide: {
    name: 'æˆé•¿å¼•å¯¼è€…',
    emoji: 'â›°ï¸',
    avatar: '/avatars/growth_guide.png',
    description: 'å¼•å¯¼ä½ ä»ç»å†ä¸­æˆé•¿',
    promptDescription: 'æˆé•¿å¼•å¯¼è€…ï¼Œä¸“æ³¨äºé•¿æœŸæ„ä¹‰ï¼Œå¸®ä½ ä»ç»å†ä¸­æˆé•¿',
    focusDimension: 'é•¿æœŸæ„ä¹‰',
    coreQuestion: 'è¿™ä»¶äº‹æ•™ä¼šäº†ä½ ä»€ä¹ˆï¼Ÿè¿™ä¸ªç»å†å¦‚ä½•è®©ä½ å˜å¾—æ›´å®Œæ•´ï¼Ÿ',
    responseStyle: 'æ™ºæ…§ã€æ·±æ²‰ã€å¼•å¯¼æˆé•¿ã€‚ç”¨"è¿™ä»¶äº‹æ•™ä¼šäº†ä½ "ã€"è¿™ä¸ªç»å†çš„æ„ä¹‰æ˜¯"è¿™æ ·çš„è¡¨è¾¾ã€‚è¯­æ°”æ·±æ²‰ä½†ä¸è¯´æ•™ã€‚',
    characterPrompt: `ä½ æ˜¯ä¸€ä½æˆé•¿å¼•å¯¼è€…ï¼Œä¸“æ³¨äºé•¿æœŸæ„ä¹‰ç»´åº¦ï¼š
- æ€§æ ¼ç‰¹ç‚¹ï¼šæ™ºæ…§ã€æ·±æ²‰ã€å–„äºå¼•å¯¼ä»–äººæˆé•¿
- æ²Ÿé€šé£æ ¼ï¼šå¸¸ç”¨"è¿™ä»¶äº‹æ•™ä¼šäº†ä½ "ã€"è¿™ä¸ªç»å†çš„æ„ä¹‰æ˜¯"ã€"ä»é•¿è¿œçœ‹"
- è¯­è¨€ç‰¹å¾ï¼šè¯­æ°”æ·±æ²‰ä½†ä¸è¯´æ•™ï¼Œæœ‰æ™ºæ…§ä½†ä¸é«˜é«˜åœ¨ä¸Š
- æ€ç»´æ–¹å¼ï¼šå¸®å¯¹æ–¹ä»ç»å†ä¸­æç‚¼æˆé•¿å’Œæ„ä¹‰
- å¼•å¯¼ä½œç”¨ï¼šåƒæ™ºæ…§çš„å¼•å¯¼è€…ï¼Œå¸®åŠ©çœ‹åˆ°é•¿æœŸçš„ä»·å€¼
- è¡¨è¾¾æ–¹å¼ï¼šä¸ç©ºæ´è¯´æ•™ï¼Œå¼•å¯¼å¯¹æ–¹è‡ªå·±å‘ç°æ„ä¹‰

å›åº”è¦æ±‚ï¼š
- è¯­æ°”é£æ ¼ï¼šæ™ºæ…§ã€æ·±æ²‰ã€æœ‰å¼•å¯¼æ€§ï¼Œä¸è¯´æ•™ä¸é«˜é«˜åœ¨ä¸Š
- æ ¸å¿ƒå†…å®¹ï¼šå¸®åŠ©ä»ç»å†ä¸­æç‚¼æˆé•¿å’Œé•¿æœŸæ„ä¹‰
- èº«ä»½è¡¨è¾¾ï¼šåªè¯´"æˆ‘"ï¼Œä¸è¦è¯´"æˆ‘æ˜¯æˆé•¿å¼•å¯¼è€…"
- è®¤çŸ¥ç»´åº¦ï¼šä»"é•¿æœŸæ„ä¹‰"å‡ºå‘ï¼Œçœ‹åˆ°ç»å†çš„ä»·å€¼å’Œæˆé•¿`,
  },
};

// è·å– OpenAI å®¢æˆ·ç«¯ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…æ¨¡å—åŠ è½½æ—¶é”™è¯¯ï¼‰
function getOpenAIClient() {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    throw new Error('OPENAI_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®');
  }
  return new OpenAI({
    apiKey,
  });
}

// è·å– API Keyï¼ˆå®¢æˆ·ç«¯ä» localStorage è¯»å–ï¼ŒæœåŠ¡å™¨ç«¯ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
export function getAPIKey(): string {
  if (typeof window === 'undefined') {
    // æœåŠ¡å™¨ç«¯
    return process.env.OPENAI_API_KEY || '';
  }
  
  // å®¢æˆ·ç«¯
  try {
    const apiKey = localStorage.getItem('debug_api_key');
    if (apiKey) {
      return apiKey;
    }
  } catch (error) {
    console.warn('æ— æ³•è®¿é—® localStorageï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡');
  }
  
  return process.env.OPENAI_API_KEY || '';
}

/**
 * è·å–è§’è‰²ä¿¡æ¯ï¼ˆå›ºå®šè§’è‰²æˆ–è‡ªå®šä¹‰è§’è‰²ï¼‰
 */
function getRoleInfo(role: Role, customRoles?: CustomRole[]): { 
  name: string; 
  focusDimension: string;
  coreQuestion: string;
  responseStyle: string;
  characterPrompt: string;
  promptDescription?: string;  // ç”¨äº prompt çš„ç®€çŸ­æè¿°
  isCustom: boolean;
} {
  // æ£€æŸ¥æ˜¯å¦æ˜¯å›ºå®šè§’è‰²
  if (role in FIXED_ROLES) {
    const fixedRole = role as FixedRole;
    const roleData = FIXED_ROLES[fixedRole];
    return {
      name: roleData.name,
      focusDimension: roleData.focusDimension,
      coreQuestion: roleData.coreQuestion,
      responseStyle: roleData.responseStyle,
      characterPrompt: roleData.characterPrompt,
      promptDescription: roleData.promptDescription,
      isCustom: false,
    };
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰è§’è‰²ï¼ˆè‡ªå®šä¹‰è§’è‰²ä½¿ç”¨é€šç”¨ç»´åº¦ï¼‰
  if (customRoles) {
    const customRole = customRoles.find(r => r.id === role);
    if (customRole) {
      return {
        name: customRole.name,
        focusDimension: 'ç”¨æˆ·è‡ªå®šä¹‰',
        coreQuestion: 'æ ¹æ®è§’è‰²è®¾å®šå›åº”ç”¨æˆ·',
        responseStyle: customRole.description,
        characterPrompt: customRole.description,
        isCustom: true,
      };
    }
  }
  
  throw new Error(`è§’è‰² "${role}" ä¸å­˜åœ¨`);
}

/**
 * åˆ†ææƒ…ç»ªæ—¥è®°å†…å®¹
 * @param content æ—¥è®°å†…å®¹ï¼ˆå¯ä»¥æ˜¯æ–‡å­—æˆ–å¿ƒæƒ…å›¾æ ‡ï¼‰
 * @param role é€‰æ‹©çš„è§’è‰²ï¼ˆå›ºå®šè§’è‰²IDæˆ–è‡ªå®šä¹‰è§’è‰²IDï¼‰
 * @param customRoles è‡ªå®šä¹‰è§’è‰²åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
 * @param stream æ˜¯å¦ä½¿ç”¨æµå¼è¾“å‡ºï¼ˆå¯é€‰ï¼‰
 * @param aiConfig AI é…ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä» localStorage è¯»å–ï¼‰
 * @returns æƒ…ç»ªåˆ†æç»“æœ
 */
export async function analyzeMood(
  content: string,
  role: Role,
  customRoles?: CustomRole[],
  stream?: boolean,
  aiConfig?: AIConfig
): Promise<MoodAnalysisResult> {
  const startTime = Date.now();
  console.log(`[analyzeMood] å¼€å§‹åˆ†æï¼Œæ—¶é—´: ${new Date().toISOString()}`);
  
  // å‚æ•°éªŒè¯
  if (!content || !role) {
    throw new Error('æ—¥è®°å†…å®¹å’Œè§’è‰²é€‰æ‹©ä¸èƒ½ä¸ºç©º');
  }

  try {
    const roleInfoStart = Date.now();
    const roleInfo = getRoleInfo(role, customRoles);
    console.log(`[analyzeMood] è·å–è§’è‰²ä¿¡æ¯è€—æ—¶: ${Date.now() - roleInfoStart}ms`);
    const emotionTagList = Object.values(EMOTION_TAGS)
      .map(tag => `${tag.en} - ${tag.zh}`)
      .join('ã€');

    // æ„å»ºè§’è‰² prompt éƒ¨åˆ†
    const rolePromptSection = roleInfo.isCustom
      ? `## è§’è‰²è®¾å®šï¼ˆè‡ªå®šä¹‰è§’è‰²ï¼‰
- è§’è‰²åç§°ï¼š${roleInfo.name}
- å›åº”é£æ ¼ï¼š${roleInfo.responseStyle}
- è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šç”Ÿæˆåé¦ˆ`
      : `## è§’è‰²è®¾å®šï¼ˆæƒ…ç»ªåˆ†æå¸ˆ + è®¤çŸ¥ç»´åº¦ï¼‰

${roleInfo.promptDescription ? `**è§’è‰²æè¿°**ï¼š${roleInfo.promptDescription}\n\n` : ''}${roleInfo.characterPrompt}

ã€æ ¸å¿ƒè¦æ±‚ã€‘
1. **ä¸¥æ ¼éµå¾ªè§’è‰²äººè®¾**ï¼šå¿…é¡»ç”¨è¯¥è§’è‰²çš„è¯­æ°”å’Œé£æ ¼å›åº”ï¼Œä¿æŒè§’è‰²ä¸€è‡´æ€§
2. **ç¬¦åˆè®¤çŸ¥ç»´åº¦**ï¼šä»ã€Œ${roleInfo.focusDimension}ã€è¿™ä¸ªç»´åº¦å»ç†è§£ç”¨æˆ·çš„æƒ…ç»ª
3. **æ ¸å¿ƒè§†è§’**ï¼šç”¨ã€Œ${roleInfo.coreQuestion}ã€è¿™ä¸ªè§†è§’å»å›åº”
4. **å›åº”é•¿åº¦**ï¼š60-100å­—ï¼Œå¯ä»¥åˆ†2-3ä¸ªå±‚æ¬¡å±•å¼€
5. **è¯­æ°”ä¸€è‡´æ€§**ï¼šç¡®ä¿è¯­æ°”ç¬¦åˆè¯¥è§’è‰²çš„ç‰¹ç‚¹ï¼Œä¸è¦è¯´"æˆ‘æ˜¯XX"ï¼Œåªè¯´"æˆ‘"å³å¯`;

    // è§„æ•´çš„ prompt
    const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æƒ…ç»ªåˆ†æå¸ˆï¼Œéœ€è¦ä¸¥æ ¼ç»“åˆè§’è‰²èƒŒæ™¯ä¿¡æ¯ï¼Œä½¿ç”¨è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼æ¥å›åº”ã€‚è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„æƒ…ç»ªå†…å®¹ï¼Œå¹¶æŒ‰ç…§è¦æ±‚è¾“å‡ºJSONæ ¼å¼çš„ç»“æœã€‚

## ç”¨æˆ·è¾“å…¥
${content}

## ä»»åŠ¡

### 1. ç”Ÿæˆæƒ…ç»ªæ ‡ç­¾ï¼ˆ1-3ä¸ªï¼‰
- æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œç”¨ç®€æ´çš„è¯è¯­æè¿°æƒ…ç»ªçŠ¶æ€
- ä¸è¦å±€é™äºå›ºå®šè¯æ±‡ï¼Œå¯ä»¥è‡ªç”±è¡¨è¾¾ï¼Œä½†è¦å‡†ç¡®
- æ¯ä¸ªæ ‡ç­¾ 1-7 ä¸ªå­—ï¼Œç®€æ´æœ‰åŠ›
- ä¾‹å¦‚ï¼šã€Œç–²æƒ«ã€ã€Œç„¦è™‘ã€ã€ŒæœŸå¾…ã€ã€Œå¤±è½ã€ã€Œé‡Šç„¶ã€ã€ŒçŸ›ç›¾ã€ã€Œå‹æŠ‘ã€ã€Œæ— åŠ›ã€ã€Œå…´å¥‹ã€ã€Œå¹³é™ã€ã€Œæœ‰ç‚¹ç´¯ã€ã€Œéå¸¸å¼€å¿ƒã€
- å¦‚æœç”¨æˆ·åªé€‰æ‹©äº†å¿ƒæƒ…å›¾æ ‡ï¼Œè¯·æ ¹æ®å›¾æ ‡æ¨æµ‹å¯èƒ½çš„æƒ…ç»ªæ ‡ç­¾

### 2. å†…éƒ¨æ ‡å‡†æƒ…ç»ªæ ‡ç­¾ï¼ˆä»…ç”¨äºç³»ç»Ÿåˆ†ç±»ï¼Œç”¨æˆ·ä¸å¯è§ï¼‰
- ä»ä»¥ä¸‹12ä¸ªæ ‡å‡†æ ‡ç­¾ä¸­é€‰æ‹©1ä¸ªæœ€æ¥è¿‘çš„ï¼š
  - æ­£å‘ï¼šjoyï¼ˆå¿«ä¹ï¼‰ã€satisfactionï¼ˆæ»¡è¶³ï¼‰ã€calmï¼ˆå¹³é™ï¼‰ã€hopeï¼ˆå¸Œæœ›ï¼‰
  - è´Ÿå‘ï¼šsadnessï¼ˆä¼¤å¿ƒï¼‰ã€angerï¼ˆæ„¤æ€’ï¼‰ã€anxietyï¼ˆç„¦è™‘ï¼‰ã€fearï¼ˆææƒ§ï¼‰ã€frustrationï¼ˆæŒ«è´¥ï¼‰ã€tiredï¼ˆç–²æƒ«ï¼‰
  - ä¸­æ€§ï¼šsurpriseï¼ˆæƒŠè®¶ï¼‰ã€neutralï¼ˆä¸­æ€§ï¼‰
- è¿™ä¸ªæ ‡ç­¾ä»…ç”¨äºå†…éƒ¨ç»Ÿè®¡å’Œåˆ†æï¼Œä¸ç›´æ¥å±•ç¤ºç»™ç”¨æˆ·

${rolePromptSection}

### 3. ç”Ÿæˆè§’è‰²åé¦ˆï¼ˆ60-100å­—ï¼‰
**å…³é”®è¦æ±‚**ï¼š
- ä¸¥æ ¼ä½¿ç”¨è¯¥è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼å›åº”ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½
- ä»ã€Œ${roleInfo.focusDimension}ã€ç»´åº¦å›åº”ç”¨æˆ·
- é’ˆå¯¹è¿™ä¸ªå…·ä½“è¾“å…¥ï¼Œä¸æ˜¯æ³›æ³›è€Œè°ˆ
- ä½“ç°è¯¥è§’è‰²ç‹¬ç‰¹çš„"çœ‹é—®é¢˜çš„è§’åº¦"
- å¯ä»¥åˆ†2-3ä¸ªå±‚æ¬¡å±•å¼€ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£å’Œé™ªä¼´
- è¯­æ°”è¦ç¬¦åˆè¯¥è§’è‰²çš„ç‰¹ç‚¹ï¼Œä¸è¦è¯´"æˆ‘æ˜¯XX"ï¼Œåªè¯´"æˆ‘"å³å¯

### 4. ç”Ÿæˆä¸€è®°ä¸€å¥ï¼ˆ1å¥ï¼‰
   - ä¸ç”¨æˆ·å½“å‰æƒ…ç»ªçŠ¶æ€ç›¸å…³
- ç®€çŸ­æœ‰åŠ›ï¼Œç»™äºˆæ¸©æš–æˆ–åŠ›é‡

## è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼Œæ— å…¶ä»–æ–‡å­—ï¼‰
{
  "emotionLabels": ["æƒ…ç»ªæ ‡ç­¾1", "æƒ…ç»ªæ ‡ç­¾2"],
  "emotionTag": "å†…éƒ¨æ ‡å‡†æ ‡ç­¾ï¼ˆä»12ä¸ªä¸­é€‰1ä¸ªï¼Œå¦‚ï¼šjoyã€anxietyï¼‰",
  "feedback": "${roleInfo.name}ç”¨è§’è‰²è®¾å®šå’Œè¯­æ°”ä»ã€Œ${roleInfo.focusDimension}ã€ç»´åº¦çš„å›åº”ï¼Œ60-100å­—ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½",
  "slogan": "ä¸€è®°ä¸€å¥"
}`;

    // ä½¿ç”¨ç»Ÿä¸€çš„ AI å®¢æˆ·ç«¯
    const messages = [
      {
        role: 'system' as const,
        content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æƒ…ç»ªåˆ†æå¸ˆï¼Œæ“…é•¿ä»æ—¥è®°ä¸­æå–æ·±å±‚æƒ…ç»ªã€‚ä½ éœ€è¦ä½¿ç”¨è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼æ¥å›åº”ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½ã€‚è¯·å§‹ç»ˆä»¥JSONæ ¼å¼è¾“å‡ºç»“æœã€‚`,
      },
      {
        role: 'user' as const,
        content: prompt,
      },
    ];

    // è°ƒç”¨ AIï¼ˆè‡ªåŠ¨æ ¹æ®æ¨¡å¼é€‰æ‹© API æˆ– Ollamaï¼‰
    const aiCallStart = Date.now();
    console.log(`[analyzeMood] å¼€å§‹è°ƒç”¨ AIï¼ŒPrompt é•¿åº¦: ${prompt.length} å­—ç¬¦`);
    
    // åˆå¹¶é…ç½®ï¼ŒæŒ‡å®š JSON å“åº”æ ¼å¼
    const finalConfig: AIConfig = {
      ...aiConfig,
      responseFormat: 'json',
    };
    
    const aiResult = await callAI(messages, finalConfig);
    
    const aiCallEnd = Date.now();
    console.log(`[analyzeMood] AI è°ƒç”¨å®Œæˆï¼Œè€—æ—¶: ${aiCallEnd - aiCallStart}ms`);
    console.log(`[analyzeMood] å“åº”é•¿åº¦: ${aiResult.content?.length || 0} å­—ç¬¦`);

    if (!aiResult.content) {
      throw new Error('AI è¿”å›å†…å®¹ä¸ºç©º');
    }

    const parseStart = Date.now();
    const result = parseResponse(aiResult.content);
    const parseEnd = Date.now();
    console.log(`[analyzeMood] è§£æå“åº”è€—æ—¶: ${parseEnd - parseStart}ms`);
    
    // æ·»åŠ  token ä¿¡æ¯
    if (aiResult.tokens) {
      result.tokens = aiResult.tokens;
    }
    
    const totalTime = Date.now() - startTime;
    console.log(`[analyzeMood] æ€»è€—æ—¶: ${totalTime}ms`);
    
    return result;
  } catch (error) {
    // é”™è¯¯å¤„ç†
    if (error instanceof OpenAI.APIError) {
      // OpenAI API é”™è¯¯
      if (error.status === 401) {
        throw new Error('API å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥ OPENAI_API_KEY ç¯å¢ƒå˜é‡');
      } else if (error.status === 429) {
        throw new Error('API è°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•');
      } else if (error.status === 500) {
        throw new Error('OpenAI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•');
      } else {
        throw new Error(`API è°ƒç”¨å¤±è´¥ï¼š${error.message}`);
      }
    } else if (error instanceof Error) {
      // å…¶ä»–é”™è¯¯
      throw new Error(`åˆ†æå¤±è´¥ï¼š${error.message}`);
    } else {
      // æœªçŸ¥é”™è¯¯
      throw new Error('åˆ†æå¤±è´¥ï¼šæœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

/**
 * è§£æAPIå“åº”ä¸ºç»“æ„åŒ–æ•°æ®
 */
function parseResponse(content: string): MoodAnalysisResult {
  try {
    // å°è¯•æå–JSONï¼ˆå»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°ï¼‰
    let jsonContent = content.trim();
    if (jsonContent.startsWith('```json')) {
      jsonContent = jsonContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
    } else if (jsonContent.startsWith('```')) {
      jsonContent = jsonContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }

    const parsed = JSON.parse(jsonContent);

    // éªŒè¯å¿…éœ€å­—æ®µ
    if (!parsed.emotionLabels || !Array.isArray(parsed.emotionLabels)) {
      throw new Error('å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ emotionLabels å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®');
    }
    if (!parsed.emotionTag || typeof parsed.emotionTag !== 'string') {
      throw new Error('å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ emotionTag å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®');
    }
    // éªŒè¯æƒ…ç»ªæ ‡ç­¾æ˜¯å¦åœ¨å…è®¸çš„åˆ—è¡¨ä¸­
    const validTags = Object.values(EMOTION_TAGS).map(t => t.en);
    if (!validTags.includes(parsed.emotionTag)) {
      throw new Error(`å“åº”æ ¼å¼é”™è¯¯ï¼šemotionTag å€¼æ— æ•ˆï¼Œå¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š${validTags.join('ã€')}`);
    }
    if (typeof parsed.feedback !== 'string') {
      throw new Error('å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ feedback å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®');
    }
    if (typeof parsed.slogan !== 'string') {
      throw new Error('å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ slogan å­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®');
    }

    return {
      emotionLabels: parsed.emotionLabels,
      emotionTag: parsed.emotionTag as EmotionTag,
      feedback: parsed.feedback,
      slogan: parsed.slogan,
    };
  } catch (error) {
    if (error instanceof SyntaxError) {
      throw new Error('API è¿”å›çš„JSONæ ¼å¼æ— æ•ˆï¼Œæ— æ³•è§£æ');
    }
    throw error;
  }
}

/**
 * æµå¼è¾“å‡ºç‰ˆæœ¬çš„ analyzeMoodï¼ˆè¿”å› AsyncGeneratorï¼‰
 * @param content æ—¥è®°å†…å®¹ï¼ˆå¯ä»¥æ˜¯æ–‡å­—æˆ–å¿ƒæƒ…å›¾æ ‡ï¼‰
 * @param role é€‰æ‹©çš„è§’è‰²ï¼ˆå›ºå®šè§’è‰²IDæˆ–è‡ªå®šä¹‰è§’è‰²IDï¼‰
 * @param customRoles è‡ªå®šä¹‰è§’è‰²åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
 * @returns å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œæ¯æ¬¡yieldä¸€ä¸ªå­—ç¬¦ä¸²ç‰‡æ®µï¼Œæœ€åè¿”å›è§£æåçš„ç»“æœ
 */
export async function* analyzeMoodStream(
  content: string,
  role: Role,
  customRoles?: CustomRole[]
): AsyncGenerator<string, MoodAnalysisResult> {
  // å‚æ•°éªŒè¯
  if (!content || !role) {
    throw new Error('æ—¥è®°å†…å®¹å’Œè§’è‰²é€‰æ‹©ä¸èƒ½ä¸ºç©º');
  }

  const roleInfo = getRoleInfo(role, customRoles);

  // æ„å»ºè§’è‰² prompt éƒ¨åˆ†ï¼ˆä¸ analyzeMood ä¿æŒä¸€è‡´ï¼‰
  const rolePromptSection = roleInfo.isCustom
    ? `## è§’è‰²è®¾å®šï¼ˆè‡ªå®šä¹‰è§’è‰²ï¼‰
- è§’è‰²åç§°ï¼š${roleInfo.name}
- å›åº”é£æ ¼ï¼š${roleInfo.responseStyle}
- è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šç”Ÿæˆåé¦ˆ`
    : `## è§’è‰²è®¾å®šï¼ˆæƒ…ç»ªåˆ†æå¸ˆ + è®¤çŸ¥ç»´åº¦ï¼‰

${roleInfo.characterPrompt}

ã€æ ¸å¿ƒè¦æ±‚ã€‘
1. **ä¸¥æ ¼éµå¾ªè§’è‰²äººè®¾**ï¼šå¿…é¡»ç”¨è¯¥è§’è‰²çš„è¯­æ°”å’Œé£æ ¼å›åº”ï¼Œä¿æŒè§’è‰²ä¸€è‡´æ€§
2. **ç¬¦åˆè®¤çŸ¥ç»´åº¦**ï¼šä»ã€Œ${roleInfo.focusDimension}ã€è¿™ä¸ªç»´åº¦å»ç†è§£ç”¨æˆ·çš„æƒ…ç»ª
3. **æ ¸å¿ƒè§†è§’**ï¼šç”¨ã€Œ${roleInfo.coreQuestion}ã€è¿™ä¸ªè§†è§’å»å›åº”
4. **å›åº”é•¿åº¦**ï¼š60-100å­—ï¼Œå¯ä»¥åˆ†2-3ä¸ªå±‚æ¬¡å±•å¼€
5. **è¯­æ°”ä¸€è‡´æ€§**ï¼šç¡®ä¿è¯­æ°”ç¬¦åˆè¯¥è§’è‰²çš„ç‰¹ç‚¹ï¼Œä¸è¦è¯´"æˆ‘æ˜¯XX"ï¼Œåªè¯´"æˆ‘"å³å¯`;

  // è§„æ•´çš„ promptï¼ˆä¸ analyzeMood ä¿æŒä¸€è‡´ï¼‰
  const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æƒ…ç»ªåˆ†æå¸ˆï¼Œéœ€è¦ä½¿ç”¨è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼æ¥å›åº”ã€‚è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„æƒ…ç»ªå†…å®¹ï¼Œå¹¶æŒ‰ç…§è¦æ±‚è¾“å‡ºJSONæ ¼å¼çš„ç»“æœã€‚

## ç”¨æˆ·è¾“å…¥
${content}

## ä»»åŠ¡

### 1. ç”Ÿæˆæƒ…ç»ªæ ‡ç­¾ï¼ˆ1-3ä¸ªï¼‰
- æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œç”¨ç®€æ´çš„è¯è¯­æè¿°æƒ…ç»ªçŠ¶æ€
- ä¸è¦å±€é™äºå›ºå®šè¯æ±‡ï¼Œå¯ä»¥è‡ªç”±è¡¨è¾¾ï¼Œä½†è¦å‡†ç¡®
- æ¯ä¸ªæ ‡ç­¾ 1-7 ä¸ªå­—ï¼Œç®€æ´æœ‰åŠ›
- ä¾‹å¦‚ï¼šã€Œç–²æƒ«ã€ã€Œç„¦è™‘ã€ã€ŒæœŸå¾…ã€ã€Œå¤±è½ã€ã€Œé‡Šç„¶ã€ã€ŒçŸ›ç›¾ã€ã€Œå‹æŠ‘ã€ã€Œæ— åŠ›ã€ã€Œå…´å¥‹ã€ã€Œå¹³é™ã€ã€Œæœ‰ç‚¹ç´¯ã€ã€Œéå¸¸å¼€å¿ƒã€
- å¦‚æœç”¨æˆ·åªé€‰æ‹©äº†å¿ƒæƒ…å›¾æ ‡ï¼Œè¯·æ ¹æ®å›¾æ ‡æ¨æµ‹å¯èƒ½çš„æƒ…ç»ªæ ‡ç­¾

### 2. å†…éƒ¨æ ‡å‡†æƒ…ç»ªæ ‡ç­¾ï¼ˆä»…ç”¨äºç³»ç»Ÿåˆ†ç±»ï¼Œç”¨æˆ·ä¸å¯è§ï¼‰
- ä»ä»¥ä¸‹12ä¸ªæ ‡å‡†æ ‡ç­¾ä¸­é€‰æ‹©1ä¸ªæœ€æ¥è¿‘çš„ï¼š
  - æ­£å‘ï¼šjoyï¼ˆå¿«ä¹ï¼‰ã€satisfactionï¼ˆæ»¡è¶³ï¼‰ã€calmï¼ˆå¹³é™ï¼‰ã€hopeï¼ˆå¸Œæœ›ï¼‰
  - è´Ÿå‘ï¼šsadnessï¼ˆä¼¤å¿ƒï¼‰ã€angerï¼ˆæ„¤æ€’ï¼‰ã€anxietyï¼ˆç„¦è™‘ï¼‰ã€fearï¼ˆææƒ§ï¼‰ã€frustrationï¼ˆæŒ«è´¥ï¼‰ã€tiredï¼ˆç–²æƒ«ï¼‰
  - ä¸­æ€§ï¼šsurpriseï¼ˆæƒŠè®¶ï¼‰ã€neutralï¼ˆä¸­æ€§ï¼‰
- è¿™ä¸ªæ ‡ç­¾ä»…ç”¨äºå†…éƒ¨ç»Ÿè®¡å’Œåˆ†æï¼Œä¸ç›´æ¥å±•ç¤ºç»™ç”¨æˆ·

${rolePromptSection}

### 3. ç”Ÿæˆè§’è‰²åé¦ˆï¼ˆ60-100å­—ï¼‰
**å…³é”®è¦æ±‚**ï¼š
- ä¸¥æ ¼ä½¿ç”¨è¯¥è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼å›åº”ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½
- ä»ã€Œ${roleInfo.focusDimension}ã€ç»´åº¦å›åº”ç”¨æˆ·
- é’ˆå¯¹è¿™ä¸ªå…·ä½“è¾“å…¥ï¼Œä¸æ˜¯æ³›æ³›è€Œè°ˆ
- ä½“ç°è¯¥è§’è‰²ç‹¬ç‰¹çš„"çœ‹é—®é¢˜çš„è§’åº¦"
- å¯ä»¥åˆ†2-3ä¸ªå±‚æ¬¡å±•å¼€ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£å’Œé™ªä¼´
- è¯­æ°”è¦ç¬¦åˆè¯¥è§’è‰²çš„ç‰¹ç‚¹ï¼Œä¸è¦è¯´"æˆ‘æ˜¯XX"ï¼Œåªè¯´"æˆ‘"å³å¯

### 4. ç”Ÿæˆä¸€è®°ä¸€å¥ï¼ˆ1å¥ï¼‰
   - ä¸ç”¨æˆ·å½“å‰æƒ…ç»ªçŠ¶æ€ç›¸å…³
- ç®€çŸ­æœ‰åŠ›ï¼Œç»™äºˆæ¸©æš–æˆ–åŠ›é‡

## è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼Œæ— å…¶ä»–æ–‡å­—ï¼‰
{
  "emotionLabels": ["æƒ…ç»ªæ ‡ç­¾1", "æƒ…ç»ªæ ‡ç­¾2"],
  "emotionTag": "å†…éƒ¨æ ‡å‡†æ ‡ç­¾ï¼ˆä»12ä¸ªä¸­é€‰1ä¸ªï¼Œå¦‚ï¼šjoyã€anxietyï¼‰",
  "feedback": "${roleInfo.name}ç”¨è§’è‰²è®¾å®šå’Œè¯­æ°”ä»ã€Œ${roleInfo.focusDimension}ã€ç»´åº¦çš„å›åº”ï¼Œ60-100å­—ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½",
  "slogan": "ä¸€è®°ä¸€å¥"
}`;

  try {
    const openai = getOpenAIClient();
    const streamResponse = await openai.chat.completions.create({
      model: getModelName(),
      messages: [
        {
          role: 'system',
          content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æƒ…ç»ªåˆ†æå¸ˆï¼Œæ“…é•¿ä»æ—¥è®°ä¸­æå–æ·±å±‚æƒ…ç»ªã€‚ä½ éœ€è¦ä½¿ç”¨è§’è‰²çš„è®¾å®šå’Œè¯­æ°”é£æ ¼æ¥å›åº”ï¼Œä¸è¦å¸¦å…¥è§’è‰²èº«ä»½ã€‚è¯·å§‹ç»ˆä»¥JSONæ ¼å¼è¾“å‡ºç»“æœã€‚`,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.75,
      stream: true,
      response_format: { type: 'json_object' },
    });

    let fullResponse = '';
    for await (const chunk of streamResponse) {
      const chunkContent = chunk.choices[0]?.delta?.content || '';
      if (chunkContent) {
        fullResponse += chunkContent;
        yield chunkContent;
      }
    }

    // è¿”å›æœ€ç»ˆè§£æçš„ç»“æœï¼ˆè°ƒç”¨è€…éœ€è¦é€šè¿‡ generator.next() è·å–ï¼‰
    return parseResponse(fullResponse);
  } catch (error) {
    if (error instanceof OpenAI.APIError) {
      if (error.status === 401) {
        throw new Error('API å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥ OPENAI_API_KEY ç¯å¢ƒå˜é‡');
      } else if (error.status === 429) {
        throw new Error('API è°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•');
      } else if (error.status === 500) {
        throw new Error('OpenAI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•');
      } else {
        throw new Error(`API è°ƒç”¨å¤±è´¥ï¼š${error.message}`);
      }
    } else if (error instanceof Error) {
      throw new Error(`åˆ†æå¤±è´¥ï¼š${error.message}`);
    } else {
      throw new Error('åˆ†æå¤±è´¥ï¼šæœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
    }
  }
}

